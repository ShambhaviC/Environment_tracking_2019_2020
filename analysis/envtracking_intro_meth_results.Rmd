---
title: "Tracking a periodically changing environment"
header-includes:
   - \usepackage{lineno}
   - \linenumbers
   - \usepackage{float} \floatplacement{figure}{H}
   - \newcommand{\beginsupplement}{\setcounter{table}{0}  \renewcommand{\thetable}{S\arabic{table}} \setcounter{figure}{0} \renewcommand{\thefigure}{S\arabic{figure}}}
always_allow_html: yes
output:
  bookdown::html_document2:
    
    number_sections: no
    toc: no
  #     fig_caption: yes
  #     number_sections: no
  bookdown::pdf_document2:
    number_sections: no
    toc: no
  # bookdown::word_document2:
#bibliography: sinewave.bib
# csl: animal-cognition.csl
---

```{r Reading-in-the-packages}
# clearing the environment
 rm(list = ls())

# installing the required packages if needed and loading them
if (!require(rmarkdown)) {
  install.packages("rmarkdown")
}
if (!require(reshape2)) {
  install.packages("reshape2")
}
if (!require(tufte)) {
  install.packages("tufte")
}
if (!require(rticles)) {
  install.packages("rticles")
}
if (!require(knitr)) {
  install.packages("knitr")
}
if (!require(shiny)) {
  install.packages("shiny")
}
# if (!require(flextable)) {
#   install.packages("flextable")
# }
if (!require(scales)) {
  install.packages("scales")
}
if (!require(tidyverse)) {
  install.packages("tidyverse")
}
if (!require(gluedown)) {
  install.packages("gluedown")
}
if (!require(glue)) {
  install.packages("glue")
}
if (!require(ggthemes)) {
  install.packages("ggthemes")
}
if (!require(lubridate)) {
  install.packages("lubridate")
}
if (!require(ggpubr)) {
  install.packages("ggpubr")
}
if (!require(gridExtra)) {
  install.packages("gridExtra")
}
if (!require(Hmisc)) {
  install.packages("Hmisc")
}
# if (!require(brms)) {
#   install.packages("brms")
# }
if (!require(bayesplot)) {
  install.packages("bayesplot")
}
```

------------------------------------------------------------------------

```{css style settings, echo = FALSE}
blockquote {
    margin: 0 0 20px;
    font-size: 14px;
}
```

```{=html}
<style>
body {
text-align: justify}
</style>
```

------------------------------------------------------------------------

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE, 
  message = FALSE, 
  warning = FALSE, 
  fig.align = "center", 
  fig.pos = "H")
```

```{r Themes-and-CI-functions}

# creating two themes for all the plots

theme_sine <- function() {
  theme_pubr() +
    theme(
      axis.text = element_text(size = 8, family = "Times"),
      axis.title = element_text(size = 10, family = "Times"),
      strip.text.x = element_text(size = 10, family = "Times"),
      strip.text.y = element_text(size = 10, family = "Times"),
      legend.text = element_text(size = 10, family = "Times"),
      legend.title = element_text(size = 12, face = "bold", family = "Times")
    )
}

theme_sine2 <- function() {
  theme_bw() +
    theme(
      axis.text = element_text(size = 8, family = "Times"),
      axis.title = element_text(size = 10, family = "Times"),
      strip.text.x = element_text(size = 10, family = "Times"),
      strip.text.y = element_text(size = 10, family = "Times"),
      legend.text = element_text(size = 10, family = "Times"),
      legend.title = element_text(size = 12, face = "bold", family = "Times")
    )
}

 # writing a function to automate the reporting of an estimate and error bars
report_m_ci_perc <- function(tbl, par = "_r_", brackets = "round") {
  open_bracket <- case_when(
    brackets == "round" ~ "(",
    brackets == "square" ~ "[",
    brackets == "squiggly" ~ "{",
    brackets == "none" ~ "",
    TRUE ~ str_sub(brackets, 1, 1)
  )
  
  close_bracket <- case_when(
    brackets == "round" ~ ")",
    brackets == "square" ~ "]",
    brackets == "squiggly" ~ "}",
    brackets == "none" ~ "",
    TRUE ~ str_sub(brackets, 2, 2)
  )
  
  tbl <- tbl %>% 
    mutate(CI = paste0(open_bracket, "95% CI ", ymin, ", ", ymax, close_bracket))
  
    return(glue("{tbl$y}% {tbl$CI}"))
}

# writing a function to make a table to get estimates and error bars as a model output

model_outputs <- function(model, fixed_effects) {
  
# creating a table with the required values for the forest plot
t1 <- fixef(model, 
            probs = c(0.055, 0.945)) %>%
  as_tibble() %>%
  mutate(
    `Fixed effect` = fixed_effects,
    Estimate = round(Estimate, digits = 2),
    Q5.5 = round(Q5.5, digits = 2),
    Q94.5 = round(Q94.5, digits = 2)
  ) %>%
  # renaming the credibility intervals column
  mutate("89% Credibility intervals" = paste0("[", Q5.5, ", ", Q94.5, "]")) %>%
  filter(`Fixed effect` != "Intercept") %>%
  rename(labels = `Fixed effect`) %>%
  select(labels, Estimate, `89% Credibility intervals`) %>%
  mutate(All = paste0(Estimate, " ", `89% Credibility intervals`)) %>%
  select(labels, All)
}

# setting the maximum value on the x axis to locate the labels
max_xvalue_output <- function(model, fixed_effects) {
  
max_xvalue <- fixef(model, 
                    probs = c(0.055, 0.945))%>%
  as_tibble() %>%
  mutate(
    `Fixed effect` = fixed_effects,
    Estimate = round(Estimate, digits = 2),
    Q5.5 = round(Q5.5, digits = 2),
    Q94.5 = round(Q94.5, digits = 2)
  ) %>%
  filter(`Fixed effect` != "Intercept") %>%
  select(Q94.5) %>%
  filter(Q94.5 == max(Q94.5)) %>%
  as.numeric()

}

```

# Introduction (this needs expanding and more references, but for now it is just an overview of the rationale behind the experiment)

* Intro sentences
1) Bats forage in the wild 
2) Flower nectar-levels are the crucial resource

* This environment changes in a regular way
1) The things that affect nectar-levels

Glossophagine nectar-feeding bats find flowering plants primarily by detecting their smell or echo-acoustic signature. The nectar within the flowers is a crucial food resource for the bats and can vary greatly in both availability and quantity: the occurrence of the flowering season, the health of the plant or flower, and the number of competitor bats all affect a flower's nectar availability. Importantly, flowers depleted of nectar gradually replenish themselves. Nectar-feeding bats use their excellent spatial memory to relocate flowers, and so can potentially track varying nectar-levels in flowers [**reference**]. 

* It's important for a forager to understand how and why that environment changes so as to exploit it effectively - just a sentence. 

* Introducing the concepts 
1) What is responding? 
2) What is tracking? 
3) What is sampling? In this example, and throughout the rest of this paper, to 'sample' means to visit an alternative currently estimated as unprofitable. (shettleworth et al. 1988). Something that is necessary where there is no readily-available cue about environmental state. 

* What do we know the bats track? What do we already know about the bats' perception of the environment? 
1) The bats can detect differences between the available options. 
2) We know Weber's law applies to volume, concentration and probability. 
3) The interaction between reward dimensions and how that drives decisions. 

The ability to perceive and respond to changes in a foraging environment is an adaptive advantage for a foraging animal. Such changes can occur along one or several reward dimensions: attributes of the food resources, some of which can affect the animal's long-term gains (**Nachev et al. 2021**). It is well-established that the bat species *Glossophaga soricina* and *Glossophaga commissarisi* (**gotta check the species names**) can differentiate between nectar resources that vary along several reward dimensions: volume, concentration and probability (**all the references**). Their ability to perceive such differences is subject to the Weber-Fechner law (**reference**), which states that the just-noticeable difference to a stimulus is proportional to the magnitude of the stimulus. An addition of one biscuit to a plate of two biscuits is much more noticeable than the addition of one biscuit to a plate of 20 biscuits; the addition of ten biscuits to a plate of 20 would be equally noticeable. 

* We already know they can track a sudden change in a time-agnostic way - the simplest possible change to track, and we know what kind of reward dimensions they can discriminate between. 

* Introducing some nuance into it - what happens when such changes are time-dependent? Can the bats track change in a time-sensitive environment? In this case there is in fact a cue for the state of the environment, which is the passage of time. 

* Previous research on this topic 
1) Stephens paper and the mathematical model 
2) Shettleworth paper 
3) Optimality
3) More current research 

* Here's what we actually did - the basic outline

* Here's what we were trying to find out. 
1) Do the bats respond to the change in volume? Do the bats track, i.e., is there a change in their behaviour corresponding to the change in their environment? 
2) What are they tracking? 
3) How fast is a trackable change? 
4) How big does the difference have to be between the fixed and the fluctuating one? Now introduce the obj vs subj mean
5) Do the bats live in the past or anticipate the future? 

Previous research has shown that the perception of reward volumes by the bats is subject to Weber's Law (**should I expand on this?**) (**citations**). That is, the bats' preference for the larger of two volumes is not based on the absolute difference between stimuli, but the relative intensity of the pair of stimuli. This is calculated as the absolute difference between the volumes divided by the average of the two volumes (**citation**). In the

We aimed to choose reward volumes that the bats would perceive as subjectively equal, i.e., the difference between the maximum output of the sine wave and the fixed option would be perceived the same way as the difference between the minimum output of the sine wave and the fixed option. The fixed option was not the arithmetic mean of the sine wave, but at the point of 'subjective equality', chosen based on the psychometric curve for volume discrimination in *G. soricina* (Toelch and Winter, 2012). The reward volume of the fixed option was always 7 $\mu$L; the variable option gave a reward of 25 $\mu$L at its peak, decreasing to a minimum of 2 μL at its trough. 

In this experiment bats of the species *Glossophaga soricina* were given a choice between two options: a 'fixed' option and a 'variable' option. The fixed option gave a reward of 7 μL every time the animal visited it. The reward output of the variable option varied as a sine function of time; the peak output of the sine wave was larger than output of fixed option, and the trough was smaller than the fixed option. The bats experienced four periods of the sine wave (the period of the wave defined as the time between two successive peaks of the wave): 0.75 hours (45 minutes); 1.5 hours; 3 hours and 6 hours.  



# Materials and Methods
Both experiments were done at the Cognitive Neurobiology Lab at the Humboldt Universität zu Berlin: experiment 1 or the Subjective Mean experiment in December, 2019; experiment 2 or the Objective Mean experiment in June and July, 2020. The experiments were performed with two different sets of individual bats, and were identical in their design and procedure except for the one crucial difference of the volume of reward delivered by the fixed option (see **Experiment Schedule** below). 

## The Animals 
Bats of the species *Glossophaga soricina* (**or whatever**) from a captive colony at the Humboldt Universität were used for the experiment. The colony was a breeding population housed at 18-24$^\circ$C and 45-70% humidity on a 12-hour light-dark cycle (light phase: 0200 to 1400 CET, 0300 to 1500 CEST). In this colony every bat older than approximately a year is assigned a permanent ID number, which shall be referred to from now on to distinguish the individuals. The bats that were selected for the experiment were a mix of animals that had previously been exposed to the system and naive ones. 20 animals participated in the first experiment and 18 completed it: 10 females and 8 males. 19 animals participated in the second experiment and 16 completed it: 11 females and 5 males. The ID numbers and sexes of the bats are summarized in **Table S1**   (see Supplementary Information). Only the data from the animals that completed the experiment were taken for the analysis. 

## Experimental Setup

The experimental setup was common to both experiments. 

### Reward
The reward received by the bats during the experiment was also their main source of food. The reward was a 17% by weight solution of sugar dissolved in water (prepared fresh everyday or every other day), hereafter referred to as 'nectar'. The sugar consisted of a 1:1:1 mass-mixture of sucrose, fructose and dextrose. The nectar was thus similar in composition and concentration to the nectar produced by wild chiropterophilous plants (**Baker et al., 1998**).

### Experimental Apparatus
The animals were placed in individual, adjacent cages (0.7 x 1.5 x 2.2 m) for the duration of the experiment. As there were six cages in total the experiment was carried out in batches of six bats at a time, and each individual progressed through the experiment independently of all the others. Each cage had an operant wall with two electronic reward-dispensing devices spaced approximately 30 cm apart, hereafter referred to as 'flowers'. Each flower had a circular head and a door controlled by a linear-actuator motor that could move up and down. Just inside the head of the flowers was an infra-red light barrier, and at the back of the flower was a Teflon tube that supplied the nectar to the flower. Each Teflon tube was connected to a short piece of soft peroxide-silicone tube that ran through a pinch-valve. 
The Teflon tubes were connected to a syringe pump in a branching design that ensured the length of tube between every flower and the pump was exactly equal to 470 cm. The pump was placed outside the cages on a shelf, inaccessible to the bats. The 'conversion factor' between pump steps and liquid volume was 0.324, i.e., for every step the pump moved, 0.324 $\mu$L of 17% nectar was pushed through the system. The syringe of the pump was a Hamilton 25 mL glass syringe (Sigma Aldrich) and connected to the tubing system of the flowers through five pinch valves on the pump itself. These pinch valves controlled the flow of liquid from the pump to the system and from a reservoir of liquid to the pump. The reservoir (500 mL thread bottle, Roth, Germany) was filled with fresh nectar every day and connected to the syringe through the valves. The nectar was then pushed by the syringe through the valves into the tubes. 

The flowers and the pump were connected by ethernet cables to a laptop computer (ThinkPad, IBM) that stood outside the cages. This computer ran the experimental schedule and the program used to clean and fill the systems using the PhenoSoft Control program, Phenosys GmBH, Berlin, Germany. To trigger a reward a bat had to place its nose inside the flower and break the infra-red light barrier. This sent a signal to the computer, which triggered the pinch-valve to open and the pump to move the correct number of steps. In this way the bat received the correct volume of reward. The raw data of which bats had made visits to which flowers at which time-points were recorded to the computer as comma-separated values (CSV) files.

## General Experimental Procedure
Data-collection was completely automated and happened for 12 hours every day: 1400 h - 0200 h CET for the first experiment; 1500 - 0300 h CEST for the second experiment. During data-collection - the 'experimental night' - the lights were turned off in the experiment chamber. The experimental animals were kept on the same light-dark cycle as the bats in the colony and were active during the dark phase. The experiment was prepared everyday in the morning during the light phase. First the animals were inspected to make sure they were healthy and flying well. Then a preliminary analysis of the data from the previous night was done everyday on the laptop running the experimental program using a Shiny App written in R, to make sure the program had been executed correctly and the bats had drunk sufficient nectar. The minimum quantity of nectar was an amount that yielded 25 kJ of energy. Any bat that drank less than this amount was given honey water. The bat was first caught and hand-fed, and then the honey water remained in its cage for one hour. Bats that did not drink enough nectar and showed signs of weakness for two days in a row were removed from the experiment. 

The old nectar was flushed from the system using the automated PhenoSoft program and fresh nectar refilled. Twice a week, the pump and tubing system was thoroughly cleaned: de-calcified water was flushed through the system; 70% denatured alcohol was allowed to stand in the system for one hour; water was flushed through the system several times; and the system was refilled with fresh nectar. 

At approximately 1800 h the data were checked to see if all the bats had made at least two visits to the flowers, and thus learned to trigger rewards. If they had not, they received ad-libitum honey water for the rest of the experimental night and they were replaced with another animal on the next night. 

The bats were given supplemental food in addition to the nectar from the flowers: 0.2 g of a powdered nectar mixture (NEKTAR-Plus, NEKTON GmbH, Pforzheim) and 0.3 g of the baby food Milasan (Milasan "Folgemilch 2", German Baby Food GmbH, Bad Homburg) mixed in ~1 mL of water; and 2 mL of plain water. These were given to the bats in small Eppendorf tubes attached to the operant wall of the cage but about **xx** cm below the flowers (**xx** cm from the ground). The additional food was such that the bats would prefer to visit the flowers instead, both because they were at a more comfortable height for the animals and because the nectar was much more highly preferred. The additional food was given firstly to supply micronutrients to the bats while they were in the experiment, and secondly to ensure the animals received a sufficient number of calories in case there was a technical system failure or the bats did not make a sufficient number of visits to the flowers. No technical failures occurred during either experiment.

Once an animal had completed the experiment, it was removed from the cage, weighed to see if it had lost weight since the start of the experiment, released back into the colony and replaced with another bat.

```{r}

# reading in the pump data from the subjective mean experiment
Pump_subjmean <- read.csv2("data/processed_data/Pump_subj.csv", sep = ";", header = TRUE)
# reading in the pump data from the objective mean experiment
Pump_objmean <- read.csv2("data/processed_data/Pump_obj.csv", sep = ";", header = TRUE)

# putting the two data-sets together 

Pump_data <- bind_rows(Pump_subjmean, Pump_objmean)

#calculating the pump fill time 
Filltime <- Pump_data %>% 
  filter(SystemMsg == "start pump" | SystemMsg == "end pump") %>% 
  mutate(interval = ifelse(SystemMsg == "start pump", as.numeric(difftime(lead(DateTime), DateTime, units = "secs")), "non-fill time")) %>% 
  select(DateTime, IdLabel, Cond, MsgValue1, interval) %>% 
  arrange(DateTime) %>% 
  filter(interval != "non-fill time", 
         interval < 300) %>% 
  mutate(interval = as.integer(interval)/60) %>% 
  summarise(mean_filltime = round(mean(interval), digits = 2),  
            sd_filltime = round(sd(interval), digits = 2))

# calculating the number of times the pump fills 
Fillnum <- Pump_data %>% 
  filter(SystemMsg == "start pump" | SystemMsg == "end pump") %>% 
  mutate(interval = ifelse(SystemMsg == "start pump", as.numeric(difftime(lead(DateTime), DateTime, units = "secs")), "non-fill time")) %>% 
  select(DateTime, Day, IdLabel, Cond, MsgValue1, interval) %>% 
  arrange(DateTime) %>% 
  filter(interval != "non-fill time", 
         interval < 300) %>%
  group_by(Day) %>% 
  summarise(pump_events = n()) %>% 
  ungroup() %>% 
  summarise(mean_fillnum = round(mean(pump_events), digits = 2), 
            sd_fillnum = round(sd(pump_events), digits = 2))
```

During the experimental night, when the syringe of the pump had been fully emptied, the pump had to refill with nectar from the reservoir. This event happened on average `r as.numeric(Filltime[1,1])` times per night (SD = ± `r as.numeric(Filltime[1,2])`), taking `r as.numeric(Fillnum[1,1])` minutes each time (SD = ± `r as.numeric(Fillnum[1,2])`). During this time, if the bats made visits to the flowers, they did not receive any reward. 

## Experiment Schedule 
In both experiments, one option was the 'fixed' option and the other was the 'fluctuating' option. The fluctuating option delivered a reward that varied as a sine function of time, starting at the maximum volume possible when a bat made its first visit to the fluctuating option, and proceeding through the sine-function regardless of where the bat made its subsequent visits. In the Subjective Mean experiment the reward delivered by the fixed option was selected so that the volume pair of the fixed option and the minimum output of the sine-wave; and the volume pair of the fixed option and the maximum output of the sine-wave had the same relative intensity. Thus the fixed option was the subjective mean of the peak and trough values of the sine-function. In the Objective Mean experiment, the output of the fixed option was the simple arithmetic mean of the peak and trough outputs of the fluctuating option. The maximum volume of the fluctuating option, i.e., the peak of the sine-wave, was 25 $\mu$L, and the minimum was 2 $\mu$L, so the output of the fixed option was 7 $\mu$L in the Subjective Mean experiment and 13.5 $\mu$L in the Objective Mean experiment. 

The experiment proceeded through the following stages: 

### Pre-training
On the first day of the experiment the bats were placed inside the cages and allowed to acclimatize to the new environment. The flowers were covered with a towel to prevent the animals accessing them, and containers of honey water were placed on top of the covered flowers, which the bats found easily. On this day alone no other food was given, including the supplementary NectarPlus-Milasan mixture. This was to teach the bats that food could be found only at the location of the flowers. No data were recorded by the computer on this day, and the amount of honey-water consumed was not monitored.  

### Training
Shortly before 1400 h, the towels were removed from the flowers to give the bats access to them. In this way the animals would be more motivated to explore this new feature of their environment. To teach the bats to put their noses into the flower head and trigger the reward, a drop of honey was applied to the back of the flower and a drop to the top of the flower. 

The training proceeded in five stages that repeated throughout the night. 

1. **Initial:** The doors in front of the flowers remained open, and the bats could pay a visit to whichever flower they wanted. They received a reward volume of 25 $\mu$L at both flowers. Once 50 visits had been made in total, the next phase of training began. 

2. **Forced 1:** This was a phase of forced alternation. At the start of this phase, the door in front of one of the flowers moved up to prevent access to it, forcing the bat to visit the other one. After a visit was made and the reward collected, the door of the visited flower would move up to block access to it, and door of the other flower would open. In this way the bat was alternately forced to visit both flowers, even if they hadn't before, and therefore learn that that there were two locations where food could be obtained. At this phase there was a difference in reward volume between the two flowers. Two pairs of volumes were possible: the fixed output and 2 $\mu$L; or the fixed output and 25 $\mu$L. Depending on which experiment it was, the fixed output was either 7 $\mu$L (the subjective mean) or 13.5 $\mu$L (the objective mean). Thus, the bats had to discriminate between the volume of the fixed output and the maximum and minimum output of the flucutating option. Half the bats were given one volume pair, and the other half the other volume pair. The flower on which the higher volume was given was counter-balanced across animals. After 50 visits in total (25 to each flower) the experiment moved to the next phase. 

3. **Free 1:** This was a phase of ad-libitum reward similar to the Initial phase: both flower doors were open so both flowers were freely accessible to the bats. The volume differences of the Forced 1 phase persisted. As the bats were free to visit both flowers, the preference of the bats for the flower that gave the higher volume was taken as indication of the discriminability of the volumes. After 50 visits total the experiment moved to the next phase. 
4. **Forced 2:** This was another phase of forced alternation, exactly the same as the Forced 1 phase except the volume pairs were different. Those bats that received the fixed output vs. 2 $\mu$L volume pair in the Forced 1 phase now received 25 $\mu$L vs. the fixed output and vice versa. Half the bats received the higher volume at the same flower as Forced 1 and the other half at the other flower. After 50 visits in total, 25 to each flower, the experiment moved to the next phase.

5. **Free 2:** This was similar to the Free 1 phase, in that both flowers were accessible and reward was ad-libitum, but the reward volumes at the flowers were the same as those in the phase Forced 2. In this way the bats' preferences for the higher volume of both volume pairs was determined. This phase also lasted for 50 visits in total. 

After the bats had completed all five phases, the experiment went back to the Forced 1 phase and all the phases except the Initial phase repeated themselves in order for the rest of the night. If a bat learned to trigger rewards and made visits, but not a sufficient number to experience all five phases at least once it had to repeat the Training stage on the next night. If the bat did not complete all five phases even on the second day of Training it was removed from the experiment and replaced. 

### Main Experiment
The bats experienced four experimental conditions, corresponding to four periods of the sine wave: 

* 0.75 hours
* 1.5 hours
* 3 hours
* 6 hours

During each experimental night the bats were given free choice between the fixed option and the fluctuating option whose output varied by a sine function of time. The output of the fluctuating option followed the formula: 

$$ \mathrm{y(t)} = {\rm (2\pi ft + \varphi) + D} $$

where: 

* A is the Amplitude of the wave, or the distance between the peak and the middle value of the wave
* f is the frequency of the wave, or the reciprocal of the wave period in seconds 
* t is the time point in seconds since the start of the wave
* $\varphi$ is the Phase, specifying in units of radians where the wave is when t = 0 
* D is the Displacement, or a center Amplitude that is not 0

The bats first experienced a condition for a night, during which the fixed and fluctuating options remained at the flowers they were assigned to. On the following night there was a 'reversal': the flower that had previously been the fixed option was now the fluctuating and vice versa. This was done to control for a location preference by the bats. After the bats had experienced a condition on two successive nights in this way, the next condition was given, so there were 4x2 or 8 experimental nights in total in addition to the training nights. The order of the conditions was pseudo-randomized across animals. 

We wanted to ensure that the animals were informed about the reward contingencies of both options on every night of the experiment. This meant that the animals had to make at least one visit to both options every night. Therefore, assuming the bats now had a slight preference for whichever flower they had made more visits to overall on the Training day, this flower that had been visited more during Training was made the fluctuating option on the first day of the main experiment. The sine function did not begin until the bat had made its first visit to the fluctuating option, and then it started at the peak of the wave. The idea behind this was that experiencing such a rich reward would motivate the bats to continue making visits to the variable option and thus allow them to experience the changing output, including the trough of the sine-wave. 

**insert picture and demonstrate the two waves in the two experiments**

## Data analysis 
The start of the sine wave - mention this at this point.

The possible strategies used by the bats 

# Results

```{r}
# reading in the pump data from the subjective mean experiment
Main_all <- read.csv2("data/processed_data/Main_roc.csv", sep = ";", header = TRUE)

# setting the parameters for volume calculation, sine wave calculation and pump-step conversions
# pump steps for the maximum volume of the fluctuating option
maxsine_steps <- 76
# pump steps for the minimum volume of the fixed option
minsine_steps <- 6
# conversion factor between pump-steps and microLitres of volume
step_conv <- 0.324
# converting the rewards from pump-step units to microLitres
maxsine <- step_conv * maxsine_steps
minsine <- step_conv * minsine_steps
# setting the fixed volumes as variables
fixed1 <- step_conv * 22
fixed2 <- step_conv * 42
# setting the pump steps for the fixed option
fixed_steps <- 22 

# calculating the sine-wave for the bats, with the actual start time of the wave instead of when the bat made its first rewarded visit at the fluctuating option, as explained in the supplementary information

Main_all <- Main_all %>% 
  # adding the pump steps for the two fixed options
  mutate(Fixed_steps = ifelse(Experiment == "Subjective", 22, 42), 
         Fixed_vol = Fixed_steps * step_conv)

# inserting a space between the word "Bat" and the number of the animal
Main_all <- Main_all %>% 
  mutate(Bat_word = ifelse((str_detect(IdLabel, "Bat") == TRUE), "Bat", ""), 
         Bat_number = ifelse((str_detect(IdLabel, "Bat") == TRUE), as.integer(str_extract(IdLabel, "[0-9]+")), IdLabel), 
         IdLabel = ifelse(is.na(IdLabel), IdLabel, paste0(Bat_word, " ", Bat_number))) %>% 
  select(-Bat_word, -Bat_number)

# creating a lookup table to find the first occurrence of a visit to the flower that was fluctuating on a particular day 

fluc_visits <- Main_all %>% 
  ungroup() %>% 
  group_by(Experiment, Day, IdLabel, unitLabel) %>% 
  select(Experiment, Day, IdLabel, unitLabel, outFuncLabel) %>% 
  distinct() %>% 
  filter(str_detect(outFuncLabel, "sine") | str_detect(outFuncLabel, "fix"))

# joining the lookup table to the Main table to correctly mark the unrewarded visits as fixed or fluctuating 

Main_all <- Main_all %>% 
  # first removing the original outFuncLabel column
  select(-outFuncLabel)

Main_all <- left_join(Main_all, fluc_visits, by = c("Experiment", "Day", "IdLabel", "unitLabel")) 

# removing the now unnecessary look-up table 
rm(fluc_visits)

# adding a period-day column to the table

Main_all <- Main_all %>%
  mutate(
    Rev = "Rev",
    Period_day = ifelse(Reversal == 0, Period, paste0(as.character(Period), " ", Rev))
  ) %>%
  # removing the now redundant columns
  select(-Rev, -Reversal)

# creating a look-up table for calculating the sine wave

sinewave <- Main_all %>%
  # filtering only the visits to the fluctuating output
  filter(outFuncLabel == "sineRewOut") %>%
  # selecting relevant columns from the main table to calculate the sine wave
  select(Experiment, Day, IdLabel, Period, Period_day, timediff, Amplitude, Disp, Fixed_steps, vis_vol, Tracking) %>%
  group_by(Experiment, Day, IdLabel) %>%
  mutate(
    Period = as.numeric(str_remove(Period_day, "Rev")), 
    # adding a row counter
    rown = 1:n(),
    # adding a column with the number of points on the calculated sine wave
    reps = 360
  ) %>%
  # taking the first occurrence of the fluctuating output
  filter(rown == 1)

# noting the number of columns in the data frame
nsine <- as.numeric(ncol(sinewave))

# repeating the rows by the number of points on the wave so the whole sine wave can be calculated
sinewave <- sinewave[rep(row.names(sinewave), sinewave$reps), 1:nsine]

# adding a column with the actual time increments
sinewave <- sinewave %>%
  # removing the old row counter so it can be done over
  select(-rown) %>%
  group_by(Experiment, Day, IdLabel) %>%
   mutate(
    # calculating the row counter again
    rown = 1:n(),
    # calculating the time differences with the proper increments: 12 hours are divided among 360 points on the wave
    timediff = ifelse(rown == 1, timediff, (lag(timediff) + (12 / 360) * (rown - 1))),
    # creating a dummy time column to calculate the wave so it starts at the peak regardless of the timediff column
    wavetime = 0,
    wavetime = ifelse(rown == 1, 0, (lag(wavetime) + (12 / 360) * (rown - 1))),
    # converting the time values back to seconds
    Period = Period * 3600,
    # converting the dummy time column to seconds
    wavetime = wavetime * 3600,
    # calculating the sine wave values and converting from pump step values to microLitres
    sine_vol = (Amplitude * sin(2 * pi * (1 / Period) * wavetime + (pi / 2)) + Disp) * step_conv,
    Period = Period / 3600
  ) %>%
  # removing time points that occurred after 12 hours by the calculation
  filter(timediff <= 12) %>%
  # removing the now-unnecessary columns
  select(-wavetime, -reps, -rown)

```

## The unrewarded visits and the start of the sine wave 
Does this need mentioning? 

## Reversal responsive and non-responsive bats

Two clear strategies were observed in the main experimental phase. The locations of the fixed and variable options were always reversed between the two flowers on the second night of a condition to control for the bats' location preferences. While most of the bats made visits to both options on both nights, a minority did not. 4 out of the 16 bats made near-exclusive visits to the same flower on both nights of a condition, regardless of whether that flower was the fixed or the variable option. We designated these bats the 'reversal non-responders' as reversing the location of the fixed and variable options induced no behavioural response. 

**Reversal Responsive Bats**

The animals that did respond to the reversal showed a change in their choice of location corresponding to the output of the sine wave. This is represented in Figure 3. 

```{r echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width = 17, fig.height = 9}

# preparing the datasets with the sinewaves for the plots 
sine_tr_subj <- sinewave %>% 
  #Sinewave for the responsive bats in the subj exp
  filter(Tracking == "tracker", 
         Experiment == "Subjective") 

sine_tr_obj <- sinewave %>%
    #Sinewave for the responsive bats in the obj exp
  filter(Tracking == "tracker", 
         Experiment == "Objective")

sine_nt_subj <- sinewave %>% 
  #Sinewave for the responsive bats in the subj exp
  filter(Tracking == "non-tracker", 
         Experiment == "Subjective") 

sine_nt_obj <- sinewave %>%
    #Sinewave for the responsive bats in the obj exp
  filter(Tracking == "non-tracker", 
         Experiment == "Objective")

# preparing the right-hand axis for many of the following plots
optionchoice <- c("F", "V")
```

Subjective mean, tracking bats 

```{r, subjective-repr-tracking, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width = 17, fig.height = 9, fig.cap = "Figure 3: Choice behaviour of the reversal responsive bats through the course of the experimental night. Each row is one night of experimental condition, each column an individual bat. The solid black represents the output of the variable option and the red points each individual visit made by a bat. The red points to the top of the plot are visits made to the variable option and those at the bottom of the plot are visits made to the fixed option. The blue lines are a smoothing function applied to the choices of the bats"}

Main_subj_3bats <- Main_all %>% 
  filter(IdLabel == c("Bat 22", "Bat 30", "Bat 67"), 
         Experiment == "Subjective")

p1 <- Main_subj_3bats %>% 
  filter(Tracking == "tracker") %>%
  mutate(smooth = as.numeric(tsSmooth(StructTS(chosen, type = "level")))) %>%
  ggplot(aes(timediff)) +
  geom_line(data = sine_tr_subj 
            %>% filter(IdLabel == c("Bat 22", "Bat 30", "Bat 67")), aes(timediff, sine_vol)
            ) +
  geom_point(aes(y = chosen), colour = "red", alpha = 0.05, size = 1) +
  geom_line(aes(y = smooth), color = "cornflowerblue") +
  scale_x_continuous(breaks = seq(0,12,1)) +
  geom_hline(yintercept = 7, linetype = 2) +
  xlab("Hour") +
  ylab(expression(paste("Volume output of the variable option [", mu, "L]"))) +
  scale_y_continuous(limits = c(minsine, maxsine), 
                     sec.axis = sec_axis(~.,
                                         breaks = c(minsine, maxsine),
                                         labels = optionchoice)) + 
  facet_grid(Period_day ~ IdLabel, scales = "free_y") +
  theme_classic() +
  theme(plot.title = element_text(size=12)) +
  theme(strip.placement = "outside")

p1
```

Objective mean, tracking bats 
```{r, objective-repr-tracking, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width = 17, fig.height = 9, fig.cap = "Figure 3: Choice behaviour of the reversal responsive bats through the course of the experimental night. Each row is one night of experimental condition, each column an individual bat. The solid black represents the output of the variable option and the red points each individual visit made by a bat. The red points to the top of the plot are visits made to the variable option and those at the bottom of the plot are visits made to the fixed option. The blue lines are a smoothing function applied to the choices of the bats"}

Main_obj_3bats <- Main_all %>% 
  filter(IdLabel == c("Bat 74", "Bat 101", "Bat 1"), 
         Experiment == "Objective")

p2 <- Main_obj_3bats %>% 
  filter(Tracking == "tracker") %>%
  mutate(smooth = as.numeric(tsSmooth(StructTS(chosen, type = "level")))) %>%
  ggplot(aes(timediff)) +
  geom_line(data = sine_tr_obj 
            %>% filter(IdLabel == c("Bat 74", "Bat 101", "Bat 1")), aes(timediff, sine_vol)
            ) +
  geom_point(aes(y = chosen), colour = "red", alpha = 0.05, size = 1) +
  geom_line(aes(y = smooth), color = "cornflowerblue") +
  scale_x_continuous(breaks = seq(0,12,1)) +
  geom_hline(yintercept = 13.5, linetype = 2) +
  xlab("Hour") +
  ylab(expression(paste("Volume output of the variable option [", mu, "L]"))) +
  scale_y_continuous(limits = c(minsine, maxsine), 
                     sec.axis = sec_axis(~.,
                                         breaks = c(minsine, maxsine),
                                         labels = optionchoice)) + 
  facet_grid(Period_day ~ IdLabel, scales = "free_y") +
  theme_classic() +
  theme(plot.title = element_text(size=12)) +
  theme(strip.placement = "outside")

p2
```

**Non-responsive Bats** 

The first time point of the sine function was the first visit made by a bat to the variable option (see **Materials and Methods**). This meant that on those nights the fixed option was assigned to the preferred flower of a reversal non-responsive bat, the bat never experienced the changing output of the variable option and was thus 'uninformed' of all available options. By our criterion described above, these animals were excluded from statistical analyses. 

The choice behaviour of these bats is shown in Figure 4. 
 
 Subjective mean, non-tracking bats 
```{r, subjective-nontracking, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width = 14, fig.height = 9, fig.cap = "Figure 3: Choice behaviour of the reversal responsive bats through the course of the experimental night. Each row is one night of experimental condition, each column an individual bat. The solid black represents the output of the variable option and the red points each individual visit made by a bat. The red points to the top of the plot are visits made to the variable option and those at the bottom of the plot are visits made to the fixed option. The blue lines are a smoothing function applied to the choices of the bats"}

Main_subj_nt <- Main_all %>% 
  filter(Tracking == "non-tracker", 
         Experiment == "Subjective")

p3 <- Main_subj_nt %>% 
  filter(Tracking == "non-tracker") %>%
  #mutate(smooth = as.numeric(tsSmooth(StructTS(chosen, type = "level")))) %>%
  ggplot(aes(timediff)) +
  geom_line(data = sine_nt_subj,  
            #%>% filter(IdLabel == c("Bat 22", "Bat 30", "Bat 67")), 
            aes(timediff, sine_vol)
            ) +
  geom_point(aes(y = chosen), colour = "red", alpha = 0.05, size = 1) +
  #geom_line(aes(y = smooth), color = "cornflowerblue") +
  scale_x_continuous(breaks = seq(0,12,1)) +
  geom_hline(yintercept = 7, linetype = 2) +
  xlab("Hour") +
  ylab(expression(paste("Volume output of the variable option [", mu, "L]"))) +
  scale_y_continuous(limits = c(minsine, maxsine), 
                     sec.axis = sec_axis(~.,
                                         breaks = c(minsine, maxsine),
                                         labels = optionchoice)) + 
  facet_grid(Period_day ~ IdLabel, scales = "free_y") +
  theme_classic() +
  theme(plot.title = element_text(size=12)) +
  theme(strip.placement = "outside")

p3

```

Objective mean, non-tracking bats 

```{r, objective-nontracking, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width = 17, fig.height = 9, fig.cap = "Figure 3: Choice behaviour of the reversal responsive bats through the course of the experimental night. Each row is one night of experimental condition, each column an individual bat. The solid black represents the output of the variable option and the red points each individual visit made by a bat. The red points to the top of the plot are visits made to the variable option and those at the bottom of the plot are visits made to the fixed option. The blue lines are a smoothing function applied to the choices of the bats"}

Main_obj_nt <- Main_all %>% 
  filter(Tracking == "non-tracker", 
         Experiment == "Objective")

p4 <- Main_obj_nt %>% 
  filter(Tracking == "non-tracker") %>%
  #mutate(smooth = as.numeric(tsSmooth(StructTS(chosen, type = "level")))) %>%
  ggplot(aes(timediff)) +
  geom_line(data = sine_nt_obj,  
            #%>% filter(IdLabel == c("Bat 22", "Bat 30", "Bat 67")), 
            aes(timediff, sine_vol)
            ) +
  geom_point(aes(y = chosen), colour = "red", alpha = 0.05, size = 1) +
  #geom_line(aes(y = smooth), color = "cornflowerblue") +
  scale_x_continuous(breaks = seq(0,12,1)) +
  geom_hline(yintercept = 13.5, linetype = 2) +
  xlab("Hour") +
  ylab(expression(paste("Volume output of the variable option [", mu, "L]"))) +
  scale_y_continuous(limits = c(minsine, maxsine), 
                     sec.axis = sec_axis(~.,
                                         breaks = c(minsine, maxsine),
                                         labels = optionchoice)) + 
  facet_grid(Period_day ~ IdLabel, scales = "free_y") +
  theme_classic() +
  theme(plot.title = element_text(size=12)) +
  theme(strip.placement = "outside")

p4

```

## Modelling the overall strategies 
## The where

### Question 1: Do the bats match their behaviour to the state of the environment? And WHAT are they matching to? 

* Simulation of matching according to i. random choice ii. relative intensity iii. simple difference between the two options iv. the sine wave itself  v. Pure godly knowledge - which option is higher? 

* Which one fits better to the data from the responsive bats - take the pilot data for this 

* 2 GLMMs - how does this fit vary with period and value of the fluctuating option? One GLMM for each experiment. 

* Response variable - The distribution of delta squared values: normalize the volume output/relative intensity/simple difference and the preference and look at the difference between the blue and the black lines.

Predictor variable - Periods and time during the night 

* State explicitly - how does sampling change with increasing or decreasing rate of change? 

### Question 2: How profitable is the bats' strategy?

* Accuracy and the actual nectar volume consumption

The accuracy of the responsive bats was overall quite high, where accuracy is defined as the proportion of visits to the option that yields a higher volume output at the time of any given visit. This can be seen in Figure 5. In the case of the non-responsive bats, there were days when the variable option was never visited as the fixed option was at the preferred location. On these days the sine function never began, and thus the reward volume available there was always 25 $\mu$L. This meant that the bat was always choosing the less profitable option and had an accuracy of 0. 

```{r, prop-profitable, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width = 8, fig.height = 4, fig.cap = "Figure 5: Proportion of choices to the more profitable option at any given time by the a) Reversal-responders and the b) Reversal-non-responders"}

# Proportion of visits to the rewarding option

Prop_rew <- Main_all %>%
  group_by(Experiment, Day, IdLabel) %>%
  filter(!is.na(reinforce1value)) %>% 
  mutate(Prof = ifelse(sine_steps > reinforce1value, 0, 1), 
         Prof_side = ifelse(outFuncLabel == "fixRewOut", 1, 0)) %>% 
  ungroup() %>% 
  group_by(Experiment, Period, IdLabel) %>%
  mutate(Prof = case_when(outFuncLabel == "sineRewOut" & reinforce1value >= fixed_steps ~ 1, 
                          outFuncLabel == "sineRewOut" & reinforce1value < fixed_steps ~ 0,
                          outFuncLabel == "fixRewOut" & reinforce1value >= sine_steps ~ 1,
                          outFuncLabel == "fixRewOut" & reinforce1value < sine_steps ~ 0)) %>%
  ungroup() %>%
  group_by(Experiment, Period, IdLabel)

p1 <- Prop_rew %>%
  filter(Tracking == "tracker") %>% 
  group_by(Experiment, Period, IdLabel) %>%
  summarise(mean_prof = mean(Prof), total_n = n()) %>%
  ggplot(aes(as.factor(Period), mean_prof, group = IdLabel, color = IdLabel)) +
  geom_point() +
  geom_line() +
  xlab("Period and reversal") +
  ylab("Proportion of visits to the profitable option") +
  geom_hline(yintercept = 0.5, linetype = 2) +
  scale_y_continuous(limits = c(0,1)) +
  ylab ("Profitability of Choice") +
  theme_classic() +
  ggtitle("a)") +
  theme(plot.title = element_text(size=12)) +
  scale_fill_viridis_d()

p2 <- Prop_rew %>%
  filter(Tracking == "non-tracker") %>% 
  group_by(Experiment, Period, IdLabel) %>%
  summarise(mean_prof = mean(Prof), total_n = n()) %>%
  ggplot(aes(as.factor(Period), mean_prof, group = IdLabel, color = IdLabel)) +
  geom_point() +
  geom_line() +
  xlab("Period and reversal") +
  ylab("Proportion of visits to the profitable option") +
  geom_hline(yintercept = 0.5, linetype = 2) +
  scale_y_continuous(limits = c(0,1)) +
  ylab ("Profitability of Choice") +
  theme_classic() +
  ggtitle("b)") +
  theme(plot.title = element_text(size=12)) +
  scale_fill_viridis_d()

grid.arrange(p1, p2, ncol = 2)

# DO THIS WITH MEAN AND SPREAD - BLACK AND RED LINES
```

## The when 

### Question 3: Do the bats use their memory of past experience or anticipation of a future reward? 

```{r memory-anticipation, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width = 6, fig.height = 6, fig.cap = "memory vs anticipation"}

# setting minimum difference between volumes for them to be perceived as different. Can be 0
mindiff <- 0 # THIS NEEDS TO BE SELECTED PROPERLY

# creating a table to calculate preferences for when volumes are part of an 
# increasing or decreasing trend

Trends <- Main_all %>% 
  select(Experiment, DateTime, IdLabel, outFuncLabel, Fixed_steps, sine_steps, sine_vol, reinforce1value, Period, Period_day, Tracking) %>%
  group_by(Experiment, Period, Tracking, IdLabel) %>%
  mutate(sine_vol = round(sine_vol, digits = 0), 
         Prof = case_when(outFuncLabel == "sineRewOut" & reinforce1value >= Fixed_steps ~ 1,
                          outFuncLabel == "sineRewOut" & reinforce1value < Fixed_steps ~ 0,
                          outFuncLabel == "fixRewOut" & reinforce1value >= sine_steps ~ 1,
                          outFuncLabel == "fixRewOut" & reinforce1value < sine_steps ~ 0), 
         # one of the following lines can be commented out depending on how 'up' and 'down' are classified
         trend = ifelse((sine_vol - lag(sine_vol)) > mindiff, "up", ifelse((sine_vol - lag(sine_vol)) < -(mindiff), "down", "same")), 
         #accounting for the difference
         outFuncLabel = ifelse(outFuncLabel == "sineRewOut", 1, 0)) %>% 
  # filtering out the visits that were not clearly classified as upwards or downwards
  filter(!is.na(trend), 
         trend != "same", 
         Tracking == "tracker") %>%
  group_by(Experiment, Period, Tracking, trend, sine_vol) %>%
  summarise(pref_fluc = mean(outFuncLabel))

fixedvol <- data.frame(Experiment = c("Subjective", "Objective"), fixedvol = c(7, 13.5))

# plotting the summary line alone with spread of points
p5 <- Trends %>% 
  ggplot(aes(sine_vol, pref_fluc, colour = trend)) +
  geom_jitter() + 
  geom_smooth() + 
  ylim(0,1.2) +
  facet_grid(Experiment~Period) + 
  xlab ("Volume of the fluctuating option") + 
  ylab("Proportion of choices to the fluctuating option") +
  geom_vline(data = fixedvol, aes(xintercept = fixedvol), linetype = 2) +
  geom_hline(yintercept = 0.5, linetype = 3) +
  theme_bw() 

# calculating the difference in preference when a volume is part of a downward vs upward trend
Updown <- Main_all %>%
  select(DateTime, IdLabel, outFuncLabel, Fixed_steps, sine_steps, sine_vol, reinforce1value, Period, Period_day, Tracking, Experiment) %>%
  filter(sine_vol < 24 & sine_vol > 2) %>%
  group_by(Experiment, Period, Tracking, IdLabel) %>%
  mutate(sine_vol = round(sine_vol, digits = 0),
         Prof = case_when(outFuncLabel == "sineRewOut" & reinforce1value >= Fixed_steps ~ 1,
                          outFuncLabel == "sineRewOut" & reinforce1value < Fixed_steps ~ 0,
                          outFuncLabel == "fixRewOut" & reinforce1value >= sine_steps ~ 1,
                          outFuncLabel == "fixRewOut" & reinforce1value < sine_steps ~ 0), 
         # one of the following lines can be commented out depending on how 'up' and 'down' are classified
         trend = ifelse((sine_vol - lag(sine_vol)) > mindiff, "up", ifelse((sine_vol - lag(sine_vol)) < -(mindiff), "down", "same")), 
         # accounting for the difference
         outFuncLabel = ifelse(outFuncLabel == "sineRewOut", 1, 0)) %>% 
  filter(!is.na(trend)) %>%
  group_by(Experiment, Period, Tracking, IdLabel, trend, sine_vol) %>%
  summarise(pref_fluc = mean(outFuncLabel))

Up <- Updown %>% 
  filter(trend == "up", 
         Tracking == "tracker") 

Down <- Updown %>%
  filter(trend == "down", 
         Tracking == "tracker")

p6 <- Up %>% 
  ggplot(aes(sine_vol, pref_fluc)) +
  geom_line(aes(group = IdLabel, colour = trend), stat = "smooth", method = "loess", alpha = 0.3, size = 0.5) + 
  geom_line(data = Down, aes(group = IdLabel, colour = trend), stat = "smooth", method = "loess", alpha = 0.3, size = 0.5) + 
  geom_smooth(data = Trends, aes(colour = trend), se = FALSE) + 
  ylim(0,1.2) +
  facet_grid(Experiment ~ Period) + 
  xlab ("Volume of the fluctuating option") + 
  ylab("Proportion of choices to the fluctuating option") +
  geom_vline(data = fixedvol, aes(xintercept = fixedvol), linetype = 2) +
  geom_hline(yintercept = 0.5, linetype = 3) +
  theme_bw() 

#Find the difference between up and down and plot it the same way to see the effect of period and fixed vol
Diff_trend <- left_join(Up, Down, by = c("Experiment", "Period", "Tracking", "IdLabel", "sine_vol")) %>%
  rename(Down = trend.y, Up = trend.x, pref_down = pref_fluc.y, pref_up = pref_fluc.x) %>% 
  mutate(diff = pref_down - pref_up) %>% 
  filter(!is.na(diff))

Diff_pooled <- Diff_trend %>%
  group_by(Experiment, Period, Tracking, sine_vol) %>%
  summarise(diff = mean(diff))

p7 <- Diff_trend %>% 
  ggplot(aes(sine_vol, diff)) + 
  geom_line(aes(group = IdLabel), stat = "smooth", method = "loess", alpha = 0.3) + 
  geom_smooth(data = Diff_pooled, se = FALSE) + 
  ylim(-1, 1) + 
  geom_hline(yintercept = 0, linetype = 2) + 
  facet_grid(Experiment~Period) + 
  xlab("Volume of the fluctuating option") + 
  ylab("Diff in preference for fluctuating option: \n downward trend - upward trend") +
  theme_bw() 

ggarrange(p5, p6, nrow = 2)
```

```{r, memory-anticipation-2}
p7
```

7 Vs. 13.5 - spread of points for each case

```{r fix-fluc-points, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width = 18, fig.height = 4, fig.cap = "Figure 9: Standardized range of probabilities of visiting the variable option when the memory of the variable option goes back a) 1 visit b) 10 visits c) 50 visits"}

mindiff <- 1.5 # THIS NEEDS TO BE SELECTED PROPERLY

# setting the fixed volumes
fixed1 <- step_conv * 22
fixed2 <- step_conv * 42

Twofixed <- Main_all %>% 
  select(DateTime, IdLabel, outFuncLabel, Fixed_steps, sine_steps, sine_vol, reinforce1value, Period, Period_day, Tracking, Experiment) %>%
  group_by(Experiment, Period, Tracking, IdLabel) %>%
  mutate(Prof = case_when(outFuncLabel == "sineRewOut" & reinforce1value >= Fixed_steps ~ 1,
                          outFuncLabel == "sineRewOut" & reinforce1value < Fixed_steps ~ 0,
                          outFuncLabel == "fixRewOut" & reinforce1value >= sine_steps ~ 1,
                          outFuncLabel == "fixRewOut" & reinforce1value < sine_steps ~ 0),
         Equal = ifelse(Experiment == "Subjective" & sine_vol < (fixed2 + mindiff) & sine_vol > (fixed2 - mindiff), 1, 
                        ifelse(Experiment == "Objective" & sine_vol < (fixed1 + mindiff) & sine_vol > (fixed1 - mindiff), 1, 0)), 
         sine_vol = ifelse(Experiment == "Subjective", fixed1, fixed2),  
         Experiment = ifelse(Experiment == "Subjective", "Fl = 13.5", "Fx = 13.5")) %>% 
  filter(Equal == 1) %>% 
  select(-Equal) %>% 
  group_by(Experiment, Period, Tracking, IdLabel) %>%
  summarise(pref_high = mean(Prof))

Twofixed_conf <- Twofixed %>%
  ungroup() %>%
  filter(Tracking == "tracker") %>%
  group_by(Experiment, Period) %>% 
  group_modify(~ mean_cl_boot(.x$pref_high, conf.int = 0.95)) 

dodge <- position_dodge(width=0.1)

p8 <- Twofixed %>% 
  filter(Tracking == "tracker") %>% 
  ggplot() + 
  geom_point(aes(Experiment, pref_high, color = IdLabel, group = IdLabel)) + 
  geom_point(data = Twofixed_conf, aes(Experiment, y)) +
  geom_errorbar(data = Twofixed_conf, aes(Experiment, ymax = ymax, ymin = ymin), position = dodge) +
  facet_grid(.~Period) + 
  ylim(0,1) + 
  xlab("Volume pairs") + 
  ylab("Preference for 13.5 over 7 ± 95% CIs") + 
  geom_hline(yintercept = 0.5, linetype = 2) +
  theme_bw()

p8
```

```{r}
########
#Fixed vs fluctuating - 7 vs 13.5 split by upwards and downwards
########
#Mark upwards and downwards
min_diff <- 0 #set minimum difference between volumes for them to be perceived as different. Can be 0

mindiff <- 1.5

# calculating preferences for when volumes are part of an increasing or decreasing trend
Trend_2fix <- Main_all %>% 
  select(DateTime, IdLabel, outFuncLabel, Fixed_steps, sine_steps, sine_vol, reinforce1value, Period, Period_day, Tracking, Experiment) %>%
  group_by(Experiment, Period, Tracking, IdLabel) %>%
  mutate(Prof = case_when(outFuncLabel == "sineRewOut" & reinforce1value >= Fixed_steps ~ 1,
                          outFuncLabel == "sineRewOut" & reinforce1value < Fixed_steps ~ 0,
                          outFuncLabel == "fixRewOut" & reinforce1value >= sine_steps ~ 1,
                          outFuncLabel == "fixRewOut" & reinforce1value < sine_steps ~ 0), 
    sine_vol = round(sine_vol, digits = 0),
         trend = ifelse((sine_vol - lag(sine_vol)) > min_diff, "up", ifelse((sine_vol - lag(sine_vol)) < -(min_diff), "down", "same"))) %>%  
  #calculating whether it is an upwards or downwards trend
  filter(!is.na(trend), #removing NAs
         trend != "same", #filtering out where the volumes were the same
         Tracking == "tracker") %>% #only the trackers
  ungroup() %>%
  mutate( #Adding a column to note which choices are made when the volume pair to choose between is 7 v 13.5      
    Equal = ifelse(Experiment == "Subjective" & sine_vol <= (fixed2 + mindiff) & sine_vol >= (fixed2 - mindiff), 1, 
            ifelse(Experiment == "Objective" & sine_vol <= (fixed1 + mindiff) & sine_vol >= (fixed1 - mindiff), 1, 0)), 
    #re-labelling Experiment so that it's clear which is fixed and which is fluctuating      
    Experiment = ifelse(Experiment == "Subjective", "Fl = 13.5", "Fx = 13.5")) %>%
  #only selecting the choices we need
  filter(Equal == 1) %>% 
  #this column is redundant now
  select(-Equal) %>% 
  group_by(Experiment, Period, Tracking, IdLabel, trend) %>%
  #Calculating the preference for the higher volume
  summarise(pref_high = mean(Prof)) 

#Summary vs spread 
Trend_2fixsum <- Trend_2fix %>% 
  ungroup() %>% 
  filter(Tracking == "tracker") %>% 
  group_by(Experiment, Period, trend) %>% 
  group_modify(~ mean_cl_boot(.x$pref_high, conf.int = 0.95)) 

dodge <- position_dodge(width=0.1)

#spread of the points
p9 <- Trend_2fix %>% 
  filter(Tracking == "tracker") %>% 
  ggplot() + 
  geom_point(aes(trend, pref_high, color = IdLabel, group = IdLabel)) + 
  geom_point(data = Trend_2fixsum, aes(trend, y)) +
  geom_errorbar(data = Trend_2fixsum, aes(trend, ymax = ymax, ymin = ymin), position=dodge, width=0.25) +
  facet_grid(Experiment~Period) + 
  ylim(0,1) + 
  xlab("Volume pairs") + 
  ylab("Preference for 13.5 over 7") + 
  geom_hline(yintercept = 0.5, linetype = 2) +
  theme_bw() + 
  theme(legend.position="none")

#The differences between up and down  
Trend_2fix_diff <- Trend_2fix %>%
  spread(trend, pref_high) %>% 
  mutate(updowndiff = down - up)

Trend_2fixsum_diff <- Trend_2fix_diff %>% 
  group_by(Experiment, Period) %>% 
  group_modify(~ mean_cl_boot(.x$updowndiff, conf.int = 0.95)) %>% 
  mutate(Period = as.factor(Period))

p10 <- Trend_2fix_diff %>% 
  filter(Tracking == "tracker") %>% 
  ungroup() %>%
  mutate(Period = as.factor(Period)) %>%
  ggplot() + 
  geom_point(aes(Period, updowndiff, group = IdLabel), colour = "blue", alpha = 0.5) + 
  geom_point(data = Trend_2fixsum_diff, aes(Period, y)) +
  geom_errorbar(data = Trend_2fixsum_diff, aes(Period, ymax = ymax, ymin = ymin), position=dodge, width=0.25) +
  facet_grid(Experiment~.) + 
  ylim(-1,1) + 
  xlab("Period") +
  ylab("(Downward trend - upward trend) \n in preference for 13.5 vs 7 with mean ± 95%CI") + 
  geom_hline(yintercept = 0, linetype = 2) +
  theme_bw() + 
  theme(legend.position="none")

ggarrange(p9, p10, ncol = 2)
```

```{r}
#slopes
p11 <- Trend_2fix %>% 
  filter(Tracking == "tracker") %>% 
  ggplot() + 
  geom_line(aes(trend, pref_high, color = "red", group = IdLabel), alpha = 0.5) + 
  geom_line(data = Trend_2fixsum, aes(trend, y, color = "blue", group = Period)) +
  facet_grid(Experiment ~ Period) + 
  ylim(0,1) + 
  xlab("Volume pairs") + 
  ylab("Preference for 13.5 over 7") + 
  geom_hline(yintercept = 0.5, linetype = 2) +
  theme_bw() + 
  theme(legend.position="none")

p11
```

### Question 4: Rate of work 

```{r binning the data according to timebins to calculate the workrate}

#this is the only variable that needs to be set for the analyses below:
#the size of the bin for the data as a ratio of the wave period. Here it is set as 1/18
# setting this for a binsize that is a proportion of the period
binratio <- 1/18 

#set this for a fixed binsize in units minutes
binsize_min <- 5 

#calculating fixed binsize in seconds
binsize_sec <- binsize_min*60 

#this is the only variable that needs to be set for the analyses below:
#the size of the bin for the data as a ratio of the wave period. Here it is set as 1/18
binsize <- data.frame(Period = c(0.75, 1.5, 3, 6))
binsize <- binsize %>%
  mutate(Period_min = Period*60, 
         prop_binsize = 60*round(Period*60*binratio),
         prop_binnumber = 3600*12/prop_binsize,
         #this column for whichever actual fixed binsize is used in 
         fixed_binsize = binsize_sec, 
         #binsize is set equal for all the periods for now
         fixed_binnumber = 3600*12/binsize_sec) 

# creating a table with the information about periods and days
Datetimes <- Main_all %>% 
  ungroup() %>%
  select(Experiment, Day, Period_day, IdLabel, DateTime, Tracking) %>%
  #mutate(day = day(DateTime)) %>%
  select(-DateTime) %>%
  unique() %>%
  arrange(IdLabel)

# separating out the periods and days information for the two experiments 
Datetimes_subj <- Datetimes %>% 
  filter(Experiment == "Subjective")
Datetimes_obj <- Datetimes %>% 
  filter(Experiment == "Objective")

#####
# doing the time-bins for the subjective mean experiment 
# creating the time bins for the subjective mean experiment
timeseries_1 <- 
  data.frame(Datetime = seq.POSIXt(from = as.POSIXct("2019-12-01 14:00:00"), to = as.POSIXct("2019-12-09 02:00:00"), by = as.numeric(binsize[1,5]))) 
timeseries_2 <- 
  data.frame(Datetime = seq.POSIXt(from = as.POSIXct("2019-12-11 14:00:00"), to = as.POSIXct("2019-12-20 02:00:00"), by = as.numeric(binsize[1,5]))) 
timeseries_3 <- 
  data.frame(Datetime = seq.POSIXt(from = as.POSIXct("2019-12-22 14:00:00"), to = as.POSIXct("2019-12-31 02:00:00"), by = as.numeric(binsize[1,5]))) 

# putting together the timeseries and removing non-experimental times
timeseries <- bind_rows(timeseries_1, timeseries_2, timeseries_3) %>%
  mutate(Datetime = as.POSIXct(Datetime), 
         Hour = hour(Datetime)) %>%
  # filtering and removing the non-experimental times
  filter(Hour >= 14 | Hour < 2) %>% 
  select(-Hour) %>%
  rename(time_bins = Datetime)

# replicating the timeseries information and adding additional information on the period-days
timeseries <- bind_rows(replicate(8, timeseries, simplify = FALSE))
l <- nrow(timeseries)
seq <- c(2:9,11:19,21:29)
timeseries <- timeseries %>%  
  mutate(Period_day = rep(c(0.75, "0.75 Rev", 1.5, "1.5 Rev", 3, "3 Rev", 6, "6 Rev"), each = l/8)) %>%
  mutate(Day = rep(seq, each = binsize[1,6], times = 8))

# joining the timeseries bins and the information about the periods and days
timeseries_subj <- left_join(Datetimes_subj, timeseries, by = c("Day", "Period_day")) %>%
  filter(!is.na(IdLabel)) %>%
  arrange(IdLabel, Day, time_bins) %>% 
  mutate(Experiment = "Subjective")

# removing the individual timeseries
rm(timeseries_1, timeseries_2, timeseries_3)

#####
# creating the time bins for the objective mean experiment 
timeseries_1 <- 
  data.frame(Datetime = seq.POSIXt(from = as.POSIXct("2020-06-19 15:00:00"), to = as.POSIXct("2020-06-27 03:00:00"), by = as.numeric(binsize[1,5])))
timeseries_2 <- 
  data.frame(Datetime = seq.POSIXt(from = as.POSIXct("2020-06-29 15:00:00"), to = as.POSIXct("2020-07-10 03:00:00"), by = as.numeric(binsize[1,5])))

# putting together the timeseries and removing non-experimental times
timeseries <- bind_rows(timeseries_1, timeseries_2) %>%  
  mutate(Datetime = as.POSIXct(Datetime), 
         Hour = hour(Datetime)) %>%
  filter(Hour >= 15 | Hour < 3) %>% #Filtering and removing the non-experimental times
  select(-Hour) %>%
  rename(time_bins = Datetime)

timeseries <- bind_rows(replicate(8, timeseries, simplify = FALSE))
l <- nrow(timeseries)
seq <- c(2:9, 11:21)
timeseries <- timeseries %>%  
  mutate(Period_day = rep(c(0.75, "0.75 Rev", 1.5, "1.5 Rev", 3, "3 Rev", 6, "6 Rev"), each = l/8)) %>%
  mutate(Day = rep(seq, each = binsize[1,6], times = 8))

timeseries_obj <- left_join(Datetimes_obj, timeseries, by = c("Day", "Period_day")) %>%
  filter(!is.na(IdLabel)) %>%
  arrange(IdLabel, Day, time_bins) %>% 
  mutate(Experiment = "Objective")

# removing the individual time series
rm(timeseries_1, timeseries_2, timeseries)

# chopping up the data into time bins
Main_all <- Main_all %>%
  group_by(Experiment, Period_day, IdLabel) %>%
  mutate(time_bins = case_when(Period == 0.75 ~ floor_date(as_datetime(DateTime), unit = "5 minute"),
                               Period == 1.5 ~ floor_date(as_datetime(DateTime), unit = "5 minute"),
                               Period == 3 ~ floor_date(as_datetime(DateTime), unit = "5 minute"),
                               Period == 6 ~ floor_date(as_datetime(DateTime), unit = "5 minute")),
         #chopping up the data into bins that are 1/36 of the period
         interval = as.numeric(difftime(lead(DateTime),
                                        DateTime, units = "secs")),
         richness = factor(if_else(sine_vol >= 13.5, 1, 0)))

# creating a separate table for the workrate binning for the two experiments 
Workrate_subj <- Main_all %>%
  filter(Experiment == "Subjective") %>% 
  select(DateTime, Period, Period_day, IdLabel, outFuncLabel, vis_vol, time_bins, Tracking)

Workrate_obj <- Main_all %>%
  filter(Experiment == "Objective") %>% 
  select(DateTime, Period, Period_day, IdLabel, outFuncLabel, vis_vol, time_bins, Tracking)

# adding the timeseries information to the binned data so the empirical data are sorted into the complete series of time bins 
Workrate_subj <- full_join(timeseries_subj, Workrate_subj, by = c("Period_day", "Tracking", "IdLabel", "time_bins")) %>%
  mutate(Hour = hour(time_bins)) %>%
  filter(Hour < 2 | Hour >= 14) %>%
  select(-Hour) %>%
  mutate(vis_vol = replace_na(vis_vol, 0))

Workrate_obj <- full_join(timeseries_obj, Workrate_obj, by = c("Period_day", "Tracking", "IdLabel", "time_bins")) %>%
  mutate(Hour = hour(time_bins)) %>%
  filter(Hour < 3 | Hour >= 15) %>%
  select(-Hour) %>%
  mutate(vis_vol = replace_na(vis_vol, 0))
```

**Reversal Responsive Bats:**

The foraging environment of the bats in this experiment is not static: it fluctuates through 'rich' phases when the output of the variable option is high and 'lean' phases when the output of the variable option is low. A foraging bat could use many strategies to exploit such a regularly changing environment. Apart from choosing the more profitable option at any time, the bats could also make visits more or less frequently to take advantage of the environment's richness. To examine the frequency of visits made, or 'rate of work', the time course of the experiment was divided into small time intervals of 2 minutes, and the number of visits per interval counted. This can be seen in Figure 6. 

```{r, row-subjective-repr-trackers}
######
# creating the workrate data binned for the trackers in the subjective mean experiment 
Wr_binned_subj_tr <- Workrate_subj %>%
  filter(Tracking == "tracker") %>%
  mutate(visit = ifelse(vis_vol > 0, 1, 0)) %>%
  group_by(Tracking, Period_day, IdLabel, time_bins) %>%
  summarise(n_vis = sum(visit)) %>%
  arrange(time_bins) %>%
  ungroup() %>%
  group_by(Period_day, IdLabel) %>%
  mutate(timediff = as.numeric(difftime(time_bins, min(time_bins), units = "secs"))/3600) %>%
  ungroup() %>%
  group_by(Period_day) %>%
  mutate(range = max(n_vis) - min(n_vis),
         min = min(n_vis),
         Period = as.numeric(str_remove(Period_day, "Rev")),
         Day_rev = ifelse(str_detect(Period_day, "Rev"), "Reversal", "Condition"))

# creating a lookup table so the sine wave can be scaled correctly
Range_subj_tr <- Wr_binned_subj_tr %>%
  select(Period, Period_day, IdLabel, range, min) %>%
  distinct()

#Scaling the sinewave for the trackers
Sinewave_subj_tr <- sinewave %>% 
  filter(Experiment == "Subjective",
         Tracking == "tracker")
Sinewave_subj_tr <- left_join(Sinewave_subj_tr, Range_subj_tr, by = c("Period", "Period_day", "IdLabel")) %>%
  mutate(scaled_sine = ((sine_vol-minsine)*range/(maxsine-minsine))+min)

# selecting three representative bats from the subjective mean experiment for the plot 
Main_subj_3bats <- Main_all %>% 
  filter(IdLabel == c("Bat 16", "Bat 95", "Bat 77"), 
         Experiment == "Subjective")

#Creating the rate of work plot for the trackers
Main_subj_3bats %>%
  filter(Tracking == "tracker", 
         Experiment == "Subjective") %>%
  group_by(Period, IdLabel) %>%
  ggplot() +
  geom_line(data = Sinewave_subj_tr %>% filter(IdLabel == c("Bat 16", "Bat 95", "Bat 77")), aes(x = timediff, y = scaled_sine)) +
  geom_line(data = Wr_binned_subj_tr%>% filter(IdLabel == c("Bat 16", "Bat 95", "Bat 77")), aes(x = timediff, y = n_vis), color = "darkorange1") +
  #geom_point(aes(timediff, chosen), colour = "forestgreen", alpha = 0.05, size = 1) +
  scale_x_continuous(breaks = seq(0, 12, 1)) +
  #scale_y_continuous(breaks = seq(0, 120, 10))+
  xlab("Hour") +
  ylab("Rate of Work") +
  facet_grid(Period_day ~ IdLabel, scales = "free_y") +
  theme_classic() +
  #geom_hline(yintercept = 7, linetype = 2) +
  ggtitle("Work rate of the tracking bats (by period)") +
  scale_y_continuous(sec.axis = sec_axis(~.,
                                         breaks = c(0, max(Sinewave_subj_tr$scaled_sine)),
                                         labels = c(2, 25))) + 
  theme(plot.title = element_text(size=12)) +
  theme(strip.placement = "outside")
```

```{r, row-objective-repr-trackers}

######
# creating the workrate data binned for the trackers in the objective mean experiment 
Wr_binned_obj_tr <- Workrate_obj %>%
  filter(Tracking == "tracker") %>%
  mutate(visit = ifelse(vis_vol > 0, 1, 0)) %>%
  group_by(Tracking, Period_day, IdLabel, time_bins) %>%
  summarise(n_vis = sum(visit)) %>%
  arrange(time_bins) %>%
  ungroup() %>%
  group_by(Period_day, IdLabel) %>%
  mutate(timediff = as.numeric(difftime(time_bins, min(time_bins), units = "secs"))/3600) %>%
  ungroup() %>%
  group_by(Period_day) %>%
  mutate(range = max(n_vis) - min(n_vis),
         min = min(n_vis),
         Period = as.numeric(str_remove(Period_day, "Rev")),
         Day_rev = ifelse(str_detect(Period_day, "Rev"), "Reversal", "Condition"))

# creating a lookup table so the sine wave can be scaled correctly
Range_obj_tr <- Wr_binned_obj_tr %>%
  select(Period, Period_day, IdLabel, range, min) %>%
  distinct()

#Scaling the sinewave for the trackers
Sinewave_obj_tr <- sinewave %>% 
  filter(Experiment == "Objective",
         Tracking == "tracker")
Sinewave_obj_tr <- left_join(Sinewave_obj_tr, Range_obj_tr, by = c("Period", "Period_day", "IdLabel")) %>%
  mutate(scaled_sine = ((sine_vol-minsine)*range/(maxsine-minsine))+min)

# selecting three representative bats from the subjective mean experiment for the plot 
Main_obj_3bats <- Main_all %>% 
  filter (Experiment == "Objective", 
          IdLabel == c("Bat 1", "Bat 43", "Bat 68"))

#Creating the rate of work plot for the trackers
Main_obj_3bats %>%
  group_by(Period, IdLabel) %>%
  ggplot() +
  geom_line(data = Sinewave_obj_tr %>% filter (IdLabel == c("Bat 1", "Bat 68", "Bat 43")), aes(x = timediff, y = scaled_sine)) +
  geom_line(data = Wr_binned_obj_tr %>% filter(IdLabel == c("Bat 1", "Bat 68", "Bat 43")), aes(x = timediff, y = n_vis), color = "darkorange1") +
  #geom_point(aes(timediff, chosen), colour = "forestgreen", alpha = 0.05, size = 1) +
  scale_x_continuous(breaks = seq(0, 12, 1)) +
  #scale_y_continuous(breaks = seq(0, 120, 10))+
  xlab("Hour") +
  ylab("Rate of Work") +
  facet_grid(Period_day ~ IdLabel, scales = "free_y") +
  theme_classic() +
  #geom_hline(yintercept = 7, linetype = 2) +
  ggtitle("Work rate of the tracking bats (by period)") +
  scale_y_continuous(sec.axis = sec_axis(~.,
                                         breaks = c(0, max(Sinewave_obj_tr$scaled_sine)),
                                         labels = c(2, 25))) + 
  theme(plot.title = element_text(size=12)) +
  theme(strip.placement = "outside")

```

**Non-Responsive Bats**

[Periodicity in the non-responsive bats even though on half the days they did not experience a periodic environment at all - this bit to be written later]

```{r row-subjective-nontrackers, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width = 17, fig.height = 9, fig.cap = "Figure 7: The rate of work of the reversal-non-responsive bats, binned in 2 minute intervals"}
######
# creating the workrate data binned for the non-trackers in the subjective mean experiment
Wr_binned_subj_nt <- Workrate_subj %>%
  filter(Tracking == "non-tracker") %>%
  mutate(visit = ifelse(vis_vol > 0, 1, 0)) %>%
  group_by(Tracking, Period_day, IdLabel, time_bins) %>%
  summarise(n_vis = sum(visit)) %>%
  arrange(time_bins) %>%
  ungroup() %>%
  group_by(Period_day, IdLabel) %>%
  mutate(timediff = as.numeric(difftime(time_bins, min(time_bins), units = "secs"))/3600) %>%
  ungroup() %>%
  group_by(Period_day) %>%
  mutate(range = max(n_vis) - min(n_vis),
         min = min(n_vis),
         Period = as.numeric(str_remove(Period_day, "Rev")),
         Day_rev = ifelse(str_detect(Period_day, "Rev"), "Reversal", "Condition"))

# creating a lookup table so the sine wave can be scaled correctly
Range_subj_nt <- Wr_binned_subj_nt %>%
  select(Period, Period_day, IdLabel, range, min) %>%
  distinct()

#Scaling the sinewave for the trackers
Sinewave_subj_nt <- sinewave %>% 
  filter(Experiment == "Subjective",
         Tracking == "non-tracker")
Sinewave_subj_nt <- left_join(Sinewave_subj_nt, Range_subj_nt, by = c("Period", "Period_day", "IdLabel")) %>%
  mutate(scaled_sine = ((sine_vol-minsine)*range/(maxsine-minsine))+min)

#Creating the rate of work plot for the non-trackers
Main_all %>%
  filter(Tracking == "non-tracker", 
         Experiment == "Subjective") %>%
  group_by(Period, IdLabel) %>%
  ggplot() +
  geom_line(data = Sinewave_subj_nt, aes(x = timediff, y = scaled_sine)) +
  geom_line(data = Wr_binned_subj_nt, aes(x = timediff, y = n_vis), color = "darkorange1") +
  #geom_point(aes(timediff, chosen), colour = "forestgreen", alpha = 0.05, size = 1) +
  scale_x_continuous(breaks = seq(0, 12, 1)) +
  #scale_y_continuous(breaks = seq(0, 120, 10))+
  xlab("Hour") +
  ylab("Rate of Work") +
  facet_grid(Period_day ~ IdLabel, scales = "free_y") +
  theme_classic() +
  #geom_hline(yintercept = 7, linetype = 2) +
  ggtitle("Work rate of the tracking bats (by period)") +
  scale_y_continuous(sec.axis = sec_axis(~.,
                                         breaks = c(0, max(Sinewave_subj_tr$scaled_sine)),
                                         labels = c(2, 25))) + 
  theme(plot.title = element_text(size=12)) +
  theme(strip.placement = "outside")
```

```{r, row-objective-nontrackers}
######
# creating the workrate binned data for the non-tracking bats in the objective mean experiment

Wr_binned_obj_nt <- Workrate_obj %>%
  filter(Tracking == "non-tracker") %>%
  mutate(visit = ifelse(vis_vol > 0, 1, 0)) %>%
  group_by(Tracking, Period_day, IdLabel, time_bins) %>%
  summarise(n_vis = sum(visit)) %>%
  arrange(time_bins) %>%
  ungroup() %>%
  group_by(Period_day, IdLabel) %>%
  mutate(timediff = as.numeric(difftime(time_bins, min(time_bins), units = "secs"))/3600) %>%
  ungroup() %>%
  group_by(Period_day) %>%
  mutate(range = max(n_vis) - min(n_vis),
         min = min(n_vis),
         Period = as.numeric(str_remove(Period_day, "Rev")),
         Day_rev = ifelse(str_detect(Period_day, "Rev"), "Reversal", "Condition"))

# creating a lookup table so the sine wave can be scaled correctly
Range_obj_nt <- Wr_binned_obj_nt %>%
  select(Period, Period_day, IdLabel, range, min) %>%
  distinct()

#Scaling the sinewave for the trackers
Sinewave_obj_nt <- sinewave %>% 
  filter(Experiment == "Objective",
         Tracking == "non-tracker")
Sinewave_obj_nt <- left_join(Sinewave_obj_nt, Range_obj_nt, by = c("Period", "Period_day", "IdLabel")) %>%
  mutate(scaled_sine = ((sine_vol-minsine)*range/(maxsine-minsine))+min)

#Creating the rate of work plot for the non-trackers
Main_all %>%
  filter(Tracking == "non-tracker", 
         Experiment == "Objective") %>%
  group_by(Period, IdLabel) %>%
  ggplot() +
  geom_line(data = Sinewave_obj_nt, aes(x = timediff, y = scaled_sine)) +
  geom_line(data = Wr_binned_obj_nt, aes(x = timediff, y = n_vis), color = "darkorange1") +
  #geom_point(aes(timediff, chosen), colour = "forestgreen", alpha = 0.05, size = 1) +
  scale_x_continuous(breaks = seq(0, 12, 1)) +
  #scale_y_continuous(breaks = seq(0, 120, 10))+
  xlab("Hour") +
  ylab("Rate of Work") +
  facet_grid(Period_day ~ IdLabel, scales = "free_y") +
  theme_classic() +
  #geom_hline(yintercept = 7, linetype = 2) +
  ggtitle("Work rate of the tracking bats (by period)") +
  scale_y_continuous(sec.axis = sec_axis(~.,
                                         breaks = c(0, max(Sinewave_subj_tr$scaled_sine)),
                                         labels = c(2, 25))) + 
  theme(plot.title = element_text(size=12)) +
  theme(strip.placement = "outside")
```

# Discussion and Conclusions - this needs re-writing

> "Living backwards!" Alice repeated in great astonishment. "I never heard of such a thing!"

> " — but there's one great advantage in it, that one's memory works both ways."

> "I'm sure mine only works one way," Alice remarked. "I can't remember things before they happen."

> "It's a poor sort of memory that only works backwards," the Queen remarked.

> `r quote_footer('***Alice$\'$s Adventures in Wonderland*****, Lewis Carroll**')`

The bats can clearly differentiate between the volumes selected, although they can discriminate between the volumes with the larger absolute difference. The volumes were selected based on the psychometric curve for volume discrimination in bats in such a way, theoretically, that the two volumes in each pair would have the same subjective difference. However it does not appear that the bats perceive them in that way as the volume pair 25 v 7 $\mu$L seems to be more easily discriminable than the volume pair 7 v 2 $\mu$L. This could potentially be due to mechanical issues with the pump and tubing system. Small errors in the number of pump steps or small fluctuations in the pressure of the system could have made the smaller absolute difference in volume harder to discriminate for the bats.

When faced with the fixed and variable options, the majority of bats seemed to respond to the changing output of the variable option. As seen in Figure 3, these responsive bats' choice behaviour roughly followed the output of the variable option, indicating a sort of environment tracking behaviour. This seemed to be more pronounced as the period of the wave increased, potentially because the variable option was only very briefly in its 'bad' state (output smaller than the fixed option)  when the wave period was 45 minutes: possibly the bats could eat enough during the 'good' state to remain sated through the bad state and thus were not motivated to pay many visits to the fixed option. When the period was 6 hours the variable option was in its 'bad' state for about 2 hours, too long for the bats to stay without making visits and thus motivating them to visit the fixed option. 

Despite being informed of the location of the two flowers as food sources as well as the fact that a the locations changed its output on alternate nights, a minority of bats visited only one location and did not respond to the reversals. 

As discussed in the **Results and summary figures**, in responding to a changing environment, a bat can change where it makes visits and when it makes visits. In visiting both available options a bat varies both the 'where' and 'when' of its visits. A reversal-non-responsive animal however does not change the 'where' of its visits but only the 'when'. What sort of strategy could that result in? Looking at the distribution of the IVIs, it does appear that some of the non-responsive animals show longer IVIs when the environment is relatively poor (the output of the variable option is low), but then, so do many of the responsive animals. There does not, however, seem to be a great deal of difference in the distribution of IVIs across the 4 periods; in fact, the distributions seem remarkably consistent across all 4 conditions. 

If a reversal-non-responsive bat represents an extreme reliance on a 'when' strategy, then what does an extreme 'where' strategy look like? One version of this would be visits made at equal intervals all night long, and only the location of the visits varying based on the state of the environment. Clearly none of the bats, even the reversal-responsive ones, showed such a strategy. 

The quality of the environment changed in a deterministic way, and it is reasonable to think the bats might be relying on their memory of the variable option to make a decision. 

As the maximum range of probabilities is at the 6-hour period, it appears the probability of visiting the fixed option is higher when the wave period is higher as well. The longer the memory window the smaller the range and the higher the probabilility of 

[Question: how do you actually compare these plots to the data? Probability of visiting the variable vs actual output of the variable option?]


# Future experiments

* The volume experiment 

* Sampling and the systematic variation of reward volume + temporal availability

* Something related to memory

* Strategies: and what they mean. 

# Supplementary Information
## Details of the individual bats in the experiments

```{r message = FALSE, warning = FALSE, message = FALSE, echo=FALSE, results='asis'}
# CHECK THIS TABLE - THERE IS NO BAT 12? 
Indv_subj <- data.frame(Individual = c("12", "22", "51", "45", "43", "101", "64", "67", "16", "30", "95", "77", "87", "46", "100", "103", "80", "102", "25"), 
                        Sex = c(rep("Male", 2), "Female", rep("Male", 2), "Female", "Male", "Female", rep("Male", 2), rep("Female", 9)),
                        Status = c("Excluded: did not participate in the experiment", "Completed", "Excluded: stopped participating in the experiment", rep("Completed", 3), "Excluded: poor health", rep("Completed", 12)))

Indv_subj <- flextable(Indv_subj, cwidth = 1.5) %>% 
  hline() %>% 
  theme_booktabs() %>% 
  set_caption("Table S1: Characteristics of individual bats that participated in the Subjective Mean experiment") %>% 
  align(align = "center", part = "all") 
  # making the column names bold
  #bold(part = "header")

Indv_subj

Indv_obj <- data.frame(Individual = c("5", "74", "50", "105", "101", "55", "4", "3", "39", "54", "80", "68", "1", "70", "69", "47", "19", "43", "92", "66"), 
                        Sex = c("Female", "Male", rep("Female", 2), rep("Male", 2), rep("Female", 6), rep("Male", 2), rep("Male", 3), rep("Female", 3)),
                        Status = c(rep("Completed", 9), "Excluded: did not participate in the experiment", "Excluded: did not participate in the experiment", rep("Completed", 9)))

Indv_obj <- flextable(Indv_obj, cwidth = 1.5) %>% 
  hline() %>% 
  theme_booktabs() %>% 
  set_caption("Table S2: Characteristics of individual bats that participated in the Objective Mean experiment") %>% 
  align(align = "center", part = "all")
  # making the column names bold
  #bold(part = "header")

Indv_obj

```

## Training stage: stable volume discrimination 

```{r echo=FALSE, warning=FALSE, message=FALSE, include=FALSE}

Training <- read.csv2("data/processed_data/Training_roc.csv", sep = ";", header = TRUE)
Training <- Training %>% 
  mutate(Phase = factor(Phase, levels = c("Initial", "Forced1", "Free1", "Forced2", "Free2")))
Viscount <- Training %>% 
  group_by(Day, IdLabel) %>%
  summarise(sumvis = sum(unitLabel)) %>%
  ungroup() %>%
  summarise(meanvis = mean(sumvis), 
            sdvis = sd(sumvis)) 
Meanvis <- Viscount %>% pull(meanvis)
Sdvis <- Viscount %>% pull(sdvis)
rm(Viscount)
```

The bats made on average about `r round(Meanvis, digits = 2)` visits at the Training stage (standard deviation `r round(Sdvis, digits = 2)`), and only one of the bats had to repeat the Training day due to too few visits. 
They nearly always paid a greater number of visits to the option that yielded a higher volume of reward (Figure 1).

```{r echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.cap = "Figure 1: Number of visits to the two options during the Training stage. Numbers in bold are the number of visits paid to the two options", fig.height=13, fig.width=16}
# ggplot(Training) + 
#     geom_bar(
#       aes(x = as.factor(Phase), y = unitLabel, fill = as.factor(vis_vol), group = Flower), 
#       stat='identity', position = 'dodge'
#     ) +
#   scale_fill_manual(values = c("skyblue","royalblue", "blue", "green")) +
#     labs(fill = "Volume of reward") + 
#     geom_text(
#       aes(x = as.factor(Phase), y = unitLabel, label = unitLabel, group = Flower, fontface = "bold"),
#       position = position_dodge(width = 1),
#       vjust = -0.6, size = 3.8
#     ) +
#     #geom_text(
#     #  aes(x = as.factor(Phase), y = unitLabel, label = Flower, group = Flower), 
#     #  position = position_dodge(width = 1), 
#     #  vjust = -3, size = 4
#     #) + 
#     facet_wrap(IdLabel~., scales = "free_x") +
#     theme_bw() +
#     #scale_y_continuous(limits = c(0, 340)) +
#     xlab("Experiment Phase") + 
#     ylab("Number of Visits") 
#     # theme(axis.title = element_text(size = 18), 
#     #       axis.text.x = element_text(angle = 30, size = 13, vjust = 1.1, hjust = 1), 
#     #       strip.text.x = element_text(size = 9, margin = margin(0.08,0,0.08,0, "cm")), 
#     #       #strip.text.y = element_text(margin = margin(0.08,0,0.08,0, "cm")), 
#     #       legend.title = element_text(size=18),
#     #       legend.text = element_text(size=18))
```

The proportion of visits made by the bats to the higher volume of a pair is shown in Figure 2. While overall a greater proportion of visits was made to the higher volume of a pair (Figure 2a), this was lower for the pair '7 v 2' than '25 v 7'. 

```{r echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.cap = "Figure 2a: Difference in preference for the higher volume between the pair 25 v 7 and the pair 7 v 2. Figure 2b: Average preference for the higher option", fig.width = 14, fig.height = 7}

#Creating a dataframe with these data
# choices <- Training %>% 
#   ungroup() %>% 
#   filter(Phase == "Free1"| Phase == "Free2") %>% 
#   select(-Flower) %>%
#   spread(vis_vol, unitLabel, sep = "") %>% 
#   mutate(Pair = ifelse(is.na(vis_vol25), "7 v 2", "25 v 7"),
#            vis_vol2 = replace_na(vis_vol2, 0),
#            vis_vol25 = replace_na(vis_vol25, 0),
#            vis_vol7 = replace_na(vis_vol7, 0),
#            pref_high = ifelse(Pair == "7 v 2", 
#                               vis_vol7/(vis_vol7+vis_vol2), vis_vol25/(vis_vol7+vis_vol25))) %>%
#   select(-Phase, -vis_vol2, -vis_vol7, -vis_vol25)
# 
# #a. Plotting proportion of visits for individual bats
# n_bats <- 16 #This is the number of bats
# p1 <- choices %>% 
#   ungroup() %>% 
#   group_by(Pair) %>% 
#   summarise(mean_pref = mean(pref_high),
#             stdev_pref = sd(pref_high)) %>% 
#   ggplot(aes(Pair, mean_pref)) +
#   geom_point() +
#   geom_errorbar(aes(ymin = mean_pref - stdev_pref/sqrt(n_bats), ymax = mean_pref + stdev_pref/sqrt(n_bats)), width = 0.25, position=position_dodge(.1)) +
#   scale_y_continuous(limits = c(0,1)) + 
#   xlab("Pair") + 
#   ylab("Preference for the higher option +/- SEM") + 
#   ggtitle("b)") +
#   geom_hline(yintercept = 0.5, linetype = 2) +
#   theme_bw() + 
#   theme(plot.title = element_text(size = 11))
# 
# #b. Plotting proportion of visits averaged across bats
# choices <- choices  %>%
#   spread(Pair, pref_high) %>%
#   mutate(diff_pref = `25 v 7` - `7 v 2`, 
#          difference = "25 v 7 - 7 v 2") 
# 
# p2 <- choices %>%
#   group_by(difference) %>%
#   ggplot(aes(difference, diff_pref, color = IdLabel)) + 
#   geom_point() + 
#   ylab("Difference in preference for the higher option") +
#   geom_hline(yintercept = 0, linetype = 2) +
#   theme_bw() 
# 
# grid.arrange(p1, p2, ncol = 2)
```

## The start of the wave

```{r}
# DOT PLOT TO SHOW WHAT THE FIRST EXPERIENCED VISIT WAS 
# RED DOT PLOT FOR THE BATS THAT DID NOT EXPERIENCE THE WAVE AT ITS BEST RIGHT AT THE BEGINNING (IN CHRONOLOGICAL ORDER)
# DUE TO THE FIRST UNREWARDED VISIT 

```

## Distribution of inter-visit intervals

The time between successive visits, or inter-visit intervals (IVIs) is the 'when' part of a bat's strategy (the 'where' being the location of the visit). Simply by varying its IVIs a bat can exploit its available options in a very efficient way, for example by paying visits to the variable option only when its output is high, and resting when its output is low. Figure 10 shows the distribution of IVIs for the responsive and non-responsive bats. The two curves are the distributions from when the environment is in its 'rich' phase: the variable output is higher than the fixed output; and the 'lean phase: the variable output is lower than the fixed output. 

```{r echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width = 17, fig.height = 9, fig.cap = "Figure 10: The distribution of inter-visit intervals in the rich and the lean periods for a) the reversal-responsive bats b) the reversal non-responsive bats"}

# Main <- Main %>%
#   group_by(Period_day, IdLabel) %>%
#    mutate(interval = as.integer(difftime(lead(DateTime), DateTime, units = "secs")),
#           richness = factor(if_else(sine_vol >= 7, 1, 0))) %>%
#   filter(!is.na(reinforce1value))
# 
# #Frequency distribution of inter-visit intervals with all the data
# #a. Tracking bats
# p1 <- Main %>%
#   filter (Tracking == "tracker") %>%
#   ggplot(aes(interval, fill = richness)) +
#   geom_density(alpha = 0.3) +
#   facet_grid(IdLabel ~ Period_day) +
#   scale_x_log10() +
#   theme_bw() +
#   xlab("intervisit intervals [s]") +
#   ggtitle("a)") +
#   theme(axis.title = element_text(size = 18)) +
#   scale_fill_viridis_d()
# 
# #b. Non-tracking bats
# p2 <- Main %>%
#   filter (Tracking == "non-tracker") %>%
#   ggplot(aes(interval, fill = richness)) +
#   geom_density(alpha = 0.3) +
#   facet_grid(IdLabel ~ Period_day) +
#   scale_x_log10() +
#   theme_bw() +
#   xlab("intervisit intervals [s]") +
#   ggtitle("b)") +
#   theme(axis.title = element_text(size = 18)) +
#   scale_fill_viridis_d()
# 
# grid.arrange(p1, p2, nrow = 2)
```

If the distribution of IVIs has a later peak in the lean phase than in the rich phase, this indicates that the bats take more time between successive visits when the environment yields poorer rewards, saving the cost of repeated flights. This can be seen more clearly in a cumulative distribution plot of the IVIs in Figure 11.  

```{r echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width = 17, fig.height = 15, fig.cap = "Figure 11: The cumulative distribution of inter-visit intervals of the reversal-responsive bats in the rich and lean periods "}

# Main %>%
#   filter(Tracking == "tracker") %>%
#   group_by(Period_day, IdLabel, richness) %>%
#   ggplot(aes(interval, colour = richness)) +
#   stat_ecdf() +
#   facet_grid(IdLabel ~ Period_day) +
#   scale_x_log10() +
#   theme_bw() +
#   xlab("intervisit intervals [s]") +
#   ylab("CDF") +
#   theme(axis.title = element_text(size = 18)) 
```

```{r echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width = 17, fig.height = 5, fig.cap = "Figure 12: The cumulative distribution of inter-visit intervals of the reversal-non-responsive bats in the rich and lean periods "}
#b. Non-tracking bats
# Main %>%
#   filter(Tracking == "non-tracker") %>%
#   group_by(Period_day, IdLabel, richness) %>%
#   ggplot(aes(interval, colour = richness)) +
#   stat_ecdf() +
#   facet_grid(IdLabel ~ Period_day) +
#   scale_x_log10() +
#   theme_bw() +
#   xlab("intervisit intervals [s]") +
#   ylab("CDF") +
#   theme(axis.title = element_text(size = 10)) 
```

For most animals on most days the distributions of IVIs in the rich and lean phase seem to overlap. 

Do the bats vary the timing of their visits in the different conditions? The distribution of inter-visit intervals in the 4 conditions is plotted in Figure 13. 

```{r echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width = 4, fig.height = 9, fig.cap = "Figure 13: Distribution of inter-visit intervals in the 4 conditions"}
# Main %>%
#   ungroup() %>%
#   mutate(Period = as.factor(Period)) %>%
#   group_by(Period, IdLabel) %>%
#   ggplot(aes(interval, fill = Period)) +
#   geom_density(alpha = 0.2) +
#   scale_x_log10() +
#   facet_grid(IdLabel~.) +
#   theme_bw() +
#   xlab("intervisit intervals [s]") +
#   scale_fill_viridis_d()
```

There do not appear to be large differences in the distributions across the 4 conditions. 
